!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Nuro=t()}(this,(function(){"use strict";function e(e){return"[object Object]"===Object.prototype.toString.call(e)}function t(e){return Array.isArray(e)}function n(e){return function(n,o={},r=[]){let i,s,c;t(r)||(r=[r]),"function"==typeof n?(i="component",s="",c=n):e.has(n)?(i="component",s="",c=e.get(n)):(i="element",s=n);let u={nodeType:i,tag:s,text:"",attrs:o,children:[],componentClass:c};return u.children=r.map((e=>function(e){return null!=e&&void 0!==e.nodeType}(e)?e:{nodeType:"text",tag:"",text:e,attrs:{},children:[]})),u}}class o extends Error{constructor(e){super(e)}}class r{constructor(e){this.domPatcher=e}reconcile(e,t,n){let r=this.createPatchFunction(t,n)(e);if(r)return r;throw new o("Patch function did not return an element")}createPatchFunction(e,t){return this.diffNodes(e,t)}diffNodes(e,t){if(!t)return e=>this.domPatcher.removeNode(e);if(!("text"!==e.nodeType&&"text"!==t.nodeType||t.text===e.text&&"text"===e.nodeType&&"text"===t.nodeType))return e=>this.domPatcher.replaceNode(e,t);if("component"===t.nodeType)return e.componentClass!==t.componentClass?n=>this.domPatcher.mountComponentOnNode(n,e,t):e=>this.domPatcher.setComponentPropsOnNode(e,t.attrs);if(e.tag!==t.tag)return n=>("component"===e.nodeType&&this.domPatcher.unmountComponentOnNode(n),this.domPatcher.replaceNode(n,t));let n=this.diffAttributes(e.attrs,t.attrs);const o=this.diffChildren(e.children,t.children);return e=>(n(e),o(e),e)}diffAttributes(e,t){let n=[];for(const[e,o]of Object.entries(t))n.push((t=>(this.domPatcher.setAttribute(t,e,o),t)));for(const o in e)o in t&&null!=t[o]||n.push((e=>(this.domPatcher.removeAttribute(e,o),e)));return e=>{for(const t of n)t(e);return e}}diffChildren(e=[],t=[]){const n=[];e.forEach(((e,o)=>{n.push(this.diffNodes(e,t[o]))}));const r=[];for(const n of t.slice(e.length))r.push((e=>this.domPatcher.appendChildNode(e,n)));return e=>{if(n.length!==e.childNodes.length)throw new o("Actual child nodes in DOM does not match number of child patches");let t=function(e,t){const n=[];for(let o=0;o<Math.max(e.length,t.length);o++){let r={left:e[o],right:t[o]};n.push(r)}return n}(n,e.childNodes);for(const e of t){(0,e.left)(e.right)}for(const t of r)t(e);return e}}}function i(e,t=!0){return s(e,t)}function s(e,t){if(1===e.nodeType){let n={nodeType:"element",tag:e.tagName.toLowerCase(),text:"",attrs:{},children:[]};return Array.prototype.forEach.call(e.attributes,(e=>{n.attrs[e.name]=e.value})),n.children=function(e,t){let n=[];return Array.prototype.forEach.call(e,(e=>{if(t||8!==e.nodeType){let o=s(e,t);n.push(o)}})),n}(e.childNodes,t),n}return{nodeType:8===e.nodeType?"comment":"text",text:e.textContent||"",tag:"",attrs:{},children:[]}}function c(e){return e._nuro||(e._nuro={eventHandlers:{}}),e._nuro}function u(e){let t=c(e);if(t.component)return t.component;throw new o("Element does not have component inside context object")}function l(e){return null!=e._nuro&&null!=e._nuro.component}const a={get:function(n,o){let r=n[o];return e(r)||t(r)?"props"!==o||n.$component?(r.$component=d(n),t(r)&&r.forEach((t=>{e(t)&&(t.$component=d(n))})),new Proxy(r,a)):r:n[o]},set:function(e,t,n){e[t]=n;let o=d(e);"props"===t&&(o.$vnode.attrs=n);return o.$update(),!0},deleteProperty:function(e,t){return delete e[t],d(e).$update(),!0}};function d(e){return null!=e.$component?e.$component:e}function p(e,t){e[t]&&e[t]()}const f=new Map;function h(e){let t=f.get(e);if(t)return t;var n;let o="with(this){return "+m(i((n=e,(new DOMParser).parseFromString(n,"text/html").body.children[0]),!1))+"}";return f.set(e,o),o}function m(e){if("text"===e.nodeType){let t=e.text.replace(/\n/g,"\\n");return t=$(t),t}return void 0!==e.attrs.$if?function(e){let t=e.attrs.$if;return delete e.attrs.$if,`(${t})?${y(e)}:''`}(e):void 0!==e.attrs.$for?function(e){let t=e.attrs.$for;delete e.attrs.$for;let n=t.trim().split(" in "),o=n[0];return`...${n[1]}.map((${o})=>${m(e)})`}(e):"slot"===e.tag?"...props.children":y(e)}function y(e){let t="h(";t+="'"+e.tag+"'";let n=new Map;for(let[t,o]of Object.entries(e.attrs))t.startsWith("$")||(t.startsWith(":")?t=t.substr(1):t.startsWith("@")||(o=$(o)),n.set(t,o));if(e.attrs.$class){let t=n.has("class")?n.get("class"):"''",o=`Object.entries(${e.attrs.$class}).reduce((prevC,c)=>c[1]?prevC+=" "+c[0]:prevC,${t}).trim()`;n.set("class",o)}let o="{"+Array.from(n).map((([e,t])=>`'${e}':${t}`)).join(",")+"}";if(e.attrs.$attrs){let t=o,n=e.attrs.$attrs;o=`{...${t},...${n},...{class:(${t}.class?(${t}.class+' '+(${n}.class||'')).trim():${n}.class)}}`}if(t+=","+o,e.children.length>0){let n=[];e.children.forEach((e=>{if("text"===e.nodeType&&""===e.text.trim())return;let t=m(e);n.push(t)})),t+=",["+n.join(",")+"]"}return t+=")",t}function $(e){if(e.length<5)return"'"+e+"'";let t,n,o=!1,r="",i="";"{"===e.charAt(0)&&"{"===e.charAt(1)||(i+="'");for(let s=0;s<e.length;s++)t=e.charAt(s),n=e.length>s&&e.charAt(s+1),"{"===t&&n&&"{"===n?(0!==s&&(i+="'+"),i+="(",s++,o=!0):"}"===t?(s++,i+=r+")",o=!1,r="",s!==e.length-1&&(i+="+'")):o?r+=t:i+=t;return"'"!==t&&"}"!==t&&(i+="'"),i}function g(e){return e.split("").map(((e,t)=>{return 1===(n=e).length&&n.toLowerCase()!=n.toUpperCase()&&e===e.toUpperCase()?0===t?e.toLowerCase():"-"+e.toLowerCase():e;var n})).join("")}const C=new Map;const v=[];let w=!1;function b(e){w=e}let x=new class{constructor(e,t,n){this.mountComponent=e,this.unmountComponent=t,this.setProps=n}removeNode(e){e.remove()}replaceNode(e,t){let n=this.createNode(t);return this.unmountComponent(e),e.replaceWith(n),n}appendChildNode(e,t){return e.appendChild(this.createNode(t)),e}mountComponentOnNode(e,t,n){if(n.componentClass)return this.unmountComponent(e),this.mountComponent(n.componentClass,e,n.attrs,n.children,t);throw new o("Component class is required for component node type")}setComponentPropsOnNode(e,t){return this.setProps(e,t)}unmountComponentOnNode(e){this.unmountComponent(e)}createNode(e,t=!1){let n;if(t=t||"svg"===e.tag,"component"===e.nodeType){if(!e.componentClass)throw new o("Component class is required for component node type");{let t=document.createElement("div"),o=i(t);n=this.mountComponent(e.componentClass,t,e.attrs,e.children,o)}}else n="text"===e.nodeType?document.createTextNode(e.text):t?document.createElementNS("http://www.w3.org/2000/svg",e.tag):document.createElement(e.tag);if("component"!==e.nodeType){for(let[t,o]of Object.entries(e.attrs))this.setAttribute(n,t,o);e.children.forEach((e=>{let o=this.createNode(e,t);n.appendChild(o)}))}return n}setAttribute(e,t,n){if("checked"===t){e.checked=!!n}if(null!=n)if(t.startsWith("@")){if(r=n,"[object Function]"!==Object.prototype.toString.call(r))throw new o("Event handler must be a function");!function(e,t,n){let o=c(e),r=o.eventHandlers[t];r?r!==n&&(e.removeEventListener(t,r),e.addEventListener(t,n),o.eventHandlers[t]=n):(e.addEventListener(t,n),o.eventHandlers[t]=n)}(e,t.substring(1),n)}else e.setAttribute(t,n);var r}removeAttribute(e,t){t.startsWith("@")?function(e,t){let n=c(e);e.removeEventListener(t,n.eventHandlers[t]),delete n.eventHandlers[t]}(e,t.substring(1)):e.removeAttribute(t)}createElementInBody(e){let t=document.createElement(e);return document.body.appendChild(t),t}}(N,E,(function(e,t){return u(e).props=t,e}));function N(e,t,n,r,i){let s=new e(n);p(s,"beforeInit"),function(e){v.forEach((t=>{Object.keys(t).forEach((n=>{e[n]=t[n]}))}))}(s);let u=s.includes||{};if(s.includes=function(e,t){let n=new Map([...t]);for(let t in e){let o=e[t],r=g(t);n.set(t,o),n.set(r,o)}return n}(u,C),!s.render){if(!s.template)throw new o("Either a render method or a template string is required in a component class");{let e=h(s.template);s.render=new Function("h",e)}}s.$element=t,s.$vnode=i,s.props=n,s.props.children=r;let l=function(e){return new Proxy(e,a)}(s);return s.$update=function(){s.$pendingUpdate&&cancelAnimationFrame(s.$pendingUpdate),s.$pendingUpdate=requestAnimationFrame((()=>{A(s)})),b(!0)},function(e,t,n){(o=n,Object.getOwnPropertyNames(o.prototype).filter((e=>"constructor"!==e))).forEach((n=>{e[n]=e[n].bind(t)}));var o}(s,l,e),p(l,"beforeMount"),A(s),p(l,"afterMount"),function(e,t){c(e).component=t}(s.$element,l),s.$element}function E(e){if(null!=e&&l(e)){return T(u(e).$element,"beforeUnmount"),delete e._nuro,!0}return!1}function T(e,t){if(Array.from(e.children).forEach((e=>{T(e,t)})),l(e)){p(u(e),t)}}function A(e){p(e,"beforeRender"),b(!1);let t=n(e.includes),i=e.render(t);if(!i.nodeType)throw new o("Component render method did not return VNode");let s=new r(x).reconcile(e.$element,e.$vnode,i);return p(e,"afterRender"),e.$vnode=i,e.$element=s,e}const P=[];function O(e){requestAnimationFrame((()=>{w?O(e):e()}))}return{mount:function(e,t,n={}){return t||(t=x.createElementInBody("div")),u(N(e,t,n,[],i(t)))},unmount:E,compileTemplate:h,include:function(e,t){C.set(g(e),t)},mixin:function(e){v.push(e)},install:function(e,t={}){P.includes(e)||(e.install(this,t),P.push(e))},afterUpdate:function(){return new Promise((e=>{O(e)}))}}}));
