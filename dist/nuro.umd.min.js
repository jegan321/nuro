!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Nuro=t()}(this,(function(){"use strict";function e(e){return"[object Object]"===Object.prototype.toString.call(e)}function t(e){return Array.isArray(e)}function n(e){return function(n,r={},o=[]){let i,s,c;t(o)||(o=[o]),"function"==typeof n?(i="component",s="",c=n):e.has(n)?(i="component",s="",c=e.get(n)):(i="element",s=n);let u={nodeType:i,tag:s,text:"",attrs:r,children:[],componentClass:c};return u.children=o.map((e=>function(e){return null!=e&&void 0!==e.nodeType}(e)?e:{nodeType:"text",tag:"",text:e,attrs:{},children:[]})),u}}class r extends Error{constructor(e){super(e)}}class o{constructor(e){this.domPatcher=e}reconcile(e,t,n){let o=this.createPatchFunction(t,n)(e);if(o)return o;throw new r("Patch function did not return an element")}createPatchFunction(e,t){return this.diffNodes(e,t)}diffNodes(e,t){if(!t)return e=>this.domPatcher.removeNode(e);if(!("text"!==e.nodeType&&"text"!==t.nodeType||t.text===e.text&&"text"===e.nodeType&&"text"===t.nodeType))return e=>this.domPatcher.replaceNode(e,t);if("component"===t.nodeType)return e.componentClass!==t.componentClass?n=>this.domPatcher.mountComponentOnNode(n,e,t):e=>this.domPatcher.setComponentPropsOnNode(e,t.attrs);if(e.tag!==t.tag)return n=>("component"===e.nodeType&&this.domPatcher.unmountComponentOnNode(n),this.domPatcher.replaceNode(n,t));let n=this.diffAttributes(e.attrs,t.attrs);const r=this.diffChildren(e.children,t.children);return e=>(n(e),r(e),e)}diffAttributes(e,t){let n=[];for(const[e,r]of Object.entries(t))n.push((t=>(this.domPatcher.setAttribute(t,e,r),t)));for(const r in e)r in t&&null!=t[r]||n.push((e=>(this.domPatcher.removeAttribute(e,r),e)));return e=>{for(const t of n)t(e);return e}}diffChildren(e=[],t=[]){const n=[];e.forEach(((e,r)=>{n.push(this.diffNodes(e,t[r]))}));const o=[];for(const n of t.slice(e.length))o.push((e=>this.domPatcher.appendChildNode(e,n)));return e=>{if(n.length!==e.childNodes.length)throw new r("Actual child nodes in DOM does not match number of child patches");let t=function(e,t){const n=[];for(let r=0;r<Math.max(e.length,t.length);r++){let o={left:e[r],right:t[r]};n.push(o)}return n}(n,e.childNodes);for(const e of t){(0,e.left)(e.right)}for(const t of o)t(e);return e}}}function i(e,t=!0){return s(e,t)}function s(e,t){if(1===e.nodeType){let n={nodeType:"element",tag:e.tagName.toLowerCase(),text:"",attrs:{},children:[]};return Array.prototype.forEach.call(e.attributes,(e=>{n.attrs[e.name]=e.value})),n.children=function(e,t){let n=[];return Array.prototype.forEach.call(e,(e=>{if(t||8!==e.nodeType){let r=s(e,t);n.push(r)}})),n}(e.childNodes,t),n}return{nodeType:8===e.nodeType?"comment":"text",text:e.textContent||"",tag:"",attrs:{},children:[]}}function c(e){return e._nuro||(e._nuro={eventHandlers:{}}),e._nuro}function u(e){let t=c(e);if(t.component)return t.component;throw new r("Element does not have component inside context object")}function a(e){return null!=e._nuro&&null!=e._nuro.component}const l={get:function(n,r){let o=n[r];return e(o)||t(o)?"props"!==r||n.$component?(o.$component=d(n),t(o)&&o.forEach((t=>{e(t)&&(t.$component=d(n))})),new Proxy(o,l)):o:n[r]},set:function(e,t,n){e[t]=n;let r=d(e);"props"===t&&(r.$vnode.attrs=n);return r.$update(),!0},deleteProperty:function(e,t){return delete e[t],d(e).$update(),!0}};function d(e){return null!=e.$component?e.$component:e}function p(e,t){e[t]&&e[t]()}const f=new Map;function h(e){let t=f.get(e);if(t)return t;var n;let r="with(this){return "+m(i((n=e,(new DOMParser).parseFromString(n,"text/html").body.children[0]),!1))+"}";return f.set(e,r),r}function m(e){if("text"===e.nodeType){let t=e.text.replace(/\n/g,"\\n");return t=g(t),t}return void 0!==e.attrs.$if?function(e){let t=e.attrs.$if;return delete e.attrs.$if,`(${t})?${$(e)}:''`}(e):void 0!==e.attrs.$for?function(e){let t=e.attrs.$for;delete e.attrs.$for;let n=t.trim().split(" in "),r=n[0];return`...${n[1]}.map((${r})=>${m(e)})`}(e):"slot"===e.tag?"...props.children":$(e)}function $(e){let t="h(";t+="'"+e.tag+"'";let n=new Map;for(let[t,r]of Object.entries(e.attrs))t.startsWith("$")||(t.startsWith(":")?t=t.substr(1):t.startsWith("@")||(r=g(r)),n.set(t,r));if(e.attrs.$class){let t=n.has("class")?n.get("class"):"''",r=`Object.entries(${e.attrs.$class}).reduce((prevC,c)=>c[1]?prevC+=" "+c[0]:prevC,${t}).trim()`;n.set("class",r)}if(e.attrs.$bind){const t=e.tag,r=e.attrs.type;let o;"input"===t&&"checkbox"===r?o={prop:"checked",event:"change"}:"input"===t||"textarea"===t?o={prop:"value",event:"input"}:"select"===t&&(o={prop:"value",event:"change"}),o&&(n.set(o.prop,e.attrs.$bind),n.set("@"+o.event,`(e)=>{this.${e.attrs.$bind}=e.target.${o.prop};this.$update()}`))}let r="{"+Array.from(n).map((([e,t])=>`'${e}':${t}`)).join(",")+"}";if(e.attrs.$attrs){let t=r,n=e.attrs.$attrs;r=`{...${t},...${n},...{class:(${t}.class?(${t}.class+' '+(${n}.class||'')).trim():${n}.class)}}`}if(t+=","+r,e.children.length>0){let n=[];e.children.forEach((e=>{if("text"===e.nodeType&&""===e.text.trim())return;let t=m(e);n.push(t)})),t+=",["+n.join(",")+"]"}return t+=")",t}function g(e){if(e.length<5)return"'"+e+"'";let t,n,r=!1,o="",i="";"{"===e.charAt(0)&&"{"===e.charAt(1)||(i+="'");for(let s=0;s<e.length;s++)t=e.charAt(s),n=e.length>s&&e.charAt(s+1),"{"===t&&n&&"{"===n?(0!==s&&(i+="'+"),i+="(",s++,r=!0):"}"===t?(s++,i+=o+")",r=!1,o="",s!==e.length-1&&(i+="+'")):r?o+=t:i+=t;return"'"!==t&&"}"!==t&&(i+="'"),i}function y(e){return e.split("").map(((e,t)=>{return 1===(n=e).length&&n.toLowerCase()!=n.toUpperCase()&&e===e.toUpperCase()?0===t?e.toLowerCase():"-"+e.toLowerCase():e;var n})).join("")}const v=new Map;const b=[];let C=!1;function w(e){C=e}let x=new class{constructor(e,t,n){this.mountComponent=e,this.unmountComponent=t,this.setProps=n}removeNode(e){e.remove()}replaceNode(e,t){let n=this.createNode(t);return this.unmountComponent(e),e.replaceWith(n),n}appendChildNode(e,t){return e.appendChild(this.createNode(t)),e}mountComponentOnNode(e,t,n){if(n.componentClass)return this.unmountComponent(e),this.mountComponent(n.componentClass,e,n.attrs,n.children,t);throw new r("Component class is required for component node type")}setComponentPropsOnNode(e,t){return this.setProps(e,t)}unmountComponentOnNode(e){this.unmountComponent(e)}createNode(e,t=!1){let n;if(t=t||"svg"===e.tag,"component"===e.nodeType){if(!e.componentClass)throw new r("Component class is required for component node type");{let t=document.createElement("div"),r=i(t);n=this.mountComponent(e.componentClass,t,e.attrs,e.children,r)}}else n="text"===e.nodeType?document.createTextNode(e.text):t?document.createElementNS("http://www.w3.org/2000/svg",e.tag):document.createElement(e.tag);if("component"!==e.nodeType){for(let[t,r]of Object.entries(e.attrs))this.setAttribute(n,t,r);e.children.forEach((e=>{let r=this.createNode(e,t);n.appendChild(r)}))}return n}setAttribute(e,t,n){if("checked"===t){e.checked=!!n}if(null!=n)if(t.startsWith("@")){if(o=n,"[object Function]"!==Object.prototype.toString.call(o))throw new r("Event handler must be a function");!function(e,t,n){let r=c(e),o=r.eventHandlers[t];o?o!==n&&(e.removeEventListener(t,o),e.addEventListener(t,n),r.eventHandlers[t]=n):(e.addEventListener(t,n),r.eventHandlers[t]=n)}(e,t.substring(1),n)}else e.setAttribute(t,n);var o}removeAttribute(e,t){t.startsWith("@")?function(e,t){let n=c(e);e.removeEventListener(t,n.eventHandlers[t]),delete n.eventHandlers[t]}(e,t.substring(1)):e.removeAttribute(t)}createElementInBody(e){let t=document.createElement(e);return document.body.appendChild(t),t}}(N,E,(function(e,t){return u(e).props=t,e}));function N(e,t,n,o,i){let s=new e(n);p(s,"beforeInit"),function(e){b.forEach((t=>{Object.keys(t).forEach((n=>{e[n]=t[n]}))}))}(s);let u=s.includes||{};if(s.includes=function(e,t){let n=new Map([...t]);for(let t in e){let r=e[t],o=y(t);n.set(t,r),n.set(o,r)}return n}(u,v),!s.render){if(!s.template)throw new r("Either a render method or a template string is required in a component class");{let e=h(s.template);s.render=new Function("h",e)}}s.$element=t,s.$vnode=i,s.props=n,s.props.children=o;let a=function(e){return new Proxy(e,l)}(s);return s.$update=function(){s.$pendingUpdate&&cancelAnimationFrame(s.$pendingUpdate),s.$pendingUpdate=requestAnimationFrame((()=>{A(s)})),w(!0)},function(e,t,n){(r=n,Object.getOwnPropertyNames(r.prototype).filter((e=>"constructor"!==e))).forEach((n=>{e[n]=e[n].bind(t)}));var r}(s,a,e),p(a,"beforeMount"),A(s),p(a,"afterMount"),function(e,t){c(e).component=t}(s.$element,a),s.$element}function E(e){if(null!=e&&a(e)){return T(u(e).$element,"beforeUnmount"),delete e._nuro,!0}return!1}function T(e,t){if(Array.from(e.children).forEach((e=>{T(e,t)})),a(e)){p(u(e),t)}}function A(e){p(e,"beforeRender"),w(!1);let t=n(e.includes),i=e.render(t);if(!i.nodeType)throw new r("Component render method did not return VNode");let s=new o(x).reconcile(e.$element,e.$vnode,i);return p(e,"afterRender"),e.$vnode=i,e.$element=s,e}const P=[];function O(e){requestAnimationFrame((()=>{C?O(e):e()}))}return{mount:function(e,t,n={}){return t||(t=x.createElementInBody("div")),u(N(e,t,n,[],i(t)))},unmount:E,compileTemplate:h,include:function(e,t){v.set(y(e),t)},mixin:function(e){b.push(e)},install:function(e,t){P.includes(e)||(e.install(this,t),P.push(e))},afterUpdate:function(){return new Promise((e=>{O(e)}))}}}));
